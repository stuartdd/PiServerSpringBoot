<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Top Box for %{user}</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/styles.css">
        <script type="text/javascript" src="/rest.js" ></script>
        <script type="text/javascript">
            userList = [%{userList}];
            poleForTime = %{poleForTime};
            historyMaxLen = %{historyMaxLen};
            currentUser = "%{user}";

            volScale = [0, 68, 72, 76, 80, 84, 88, 92, 96, 99];
            volScaleNames = ["MIN", "1", "2", "3", "4", "5", "6", "7", "8", "MAX"];
            if (historyMaxLen < 2) {
                historyMaxLen = 2;
            }
            "1"
            currentDaySelect = -1;
            iconSize = 80;
            currentDisplay = "";
            currentUserCaps = capital(currentUser);
            currentThumbnailPath = "";
            currentLogFileName = "";
            imageData = "";

            imageIsZoomed = false;
            imagePathData = "";
            imageIndex = 0;
            imageIsHistoric = false;
            linkHistory = [];
            userData = {imagesPerRow: 2};
            userData.imageHistory = ["base"];
            displayMap = new Map();


            function displayPage(name) {
                var displayDataIn = {
                    name: currentDisplay,
                    X: window.scrollX || document.documentElement.scrollLeft,
                    Y: window.scrollY || document.documentElement.scrollTop
                };
                displayMap.set(currentDisplay, displayDataIn);
                document.getElementById('timeDisplay').hidden = false;
                document.getElementById('thumbnails').hidden = true;
                document.getElementById('detailsDiv').hidden = true;
                document.getElementById('logDisplayDiv').hidden = true;
                document.getElementById('thumbnailsImage').hidden = true;
                document.getElementById('originalImage').hidden = true;
                document.getElementById('originalImageZoom').hidden = true;
                document.getElementById('selectUser').hidden = true;
                document.getElementById('thumbnailsImageHistory').hidden = true;
                document.getElementById('manageAudio').hidden = true;
                document.getElementById(name).hidden = false;
                currentDisplay = name;

                if (displayMap.has(currentDisplay)) {
                    var displayDataOut = displayMap.get(currentDisplay);
                    window.scrollTo(displayDataOut.X, displayDataOut.Y);
                } else {
                    window.scrollTo(0, 0);
                }
            }


            function displayDetailsPage() {
                document.getElementById('logDisplayCode').innerHTML = "";
                document.getElementById('shareSizeText').innerHTML = "User file sizes are loading. Please wait...";
                serverGetData(setUserFileSizes, responseError, "server/ufs");
                serverGetData(setDiskStatus, responseError, "server/ds");
                serverGetData(setLogList, response404, "logs");
                displayMap.delete('detailsDiv');
                displayPage('detailsDiv');
            }


            function selectUser(user) {
                currentUser = user;
                currentUserCaps = capital(currentUser);
                loadUserData();
                document.getElementById('userNameButton').innerHTML = "Hello " + currentUserCaps + ".";
                document.getElementById('thumbnailHeading').innerHTML = "Loading data for " + currentUserCaps + " Please wait";
                document.getElementById('thumbnailDirList').innerHTML = "No Image data has been created";
                document.getElementById('thumbnailImageList').innerHTML = "No Images to display";
                document.getElementById('timeDisplay').hidden = false;
                serverGetData(setThumbnailList, responseError, "paths/user/" + currentUser + "/loc/images");
                displayMap.clear();
                displayPage("thumbnails");
            }

            function displayLoadedFile(result) {
                document.getElementById('logDisplayFile').innerHTML = "Close --> " + currentLogFileName;
                document.getElementById('logDisplayCode').innerHTML = result;
            }

            function loadLogFile(file) {
                currentLogFileName = file;
                reLoadLogFile();
            }

            function reLoadLogFile() {
                document.getElementById('logDisplayCode').innerHTML = "Please wait. Loading file: " + currentLogFileName;
                serverGetData(displayLoadedFile, responseError, "logs/file/" + currentLogFileName);
                displayMap.delete('logDisplayDiv');
                displayPage('logDisplayDiv');
            }

            /**
             * Display list of directories containing images.
             * @param {type} result The data from the server
             * @return {undefined}
             */
            function setThumbnailList(result) {
                /** 
                 * Keep the path data for later
                 */
                imagePathData = JSON.parse(result);
                refreshThumbnailList();
            }

            function refreshThumbnailList() {
                var htmlStr = "<table width=\"100%\" border=\"1\">";
                for (var i = 0; i < imagePathData.paths.length; i++) {
                    var linkClass;
                    if (linkHistory.indexOf("id" + i) >= 0) {
                        linkClass = "TableList1";
                    } else {
                        linkClass = "TableList2";
                    }
                    var span = "<a title=\"" + imagePathData.paths[i].encName + "\" href=\"javascript:loadThumbnails('" + i + "')\">" + imagePathData.paths[i].name + "</a>";
                    htmlStr += "<tr><td width=\"99%\" class=\"" + linkClass + "\">" + span + "</td></tr>";
                }
                htmlStr += "</table>";
                document.getElementById('thumbnailHeading').innerHTML = "Image directories for " + currentUserCaps;
                document.getElementById('thumbnailDirList').innerHTML = htmlStr;
            }

            /**
             * Display the thumbnails (as img tags)
             * @param {type} result from the server
             * @return {undefined}
             */
            function displayLoadedThumbnails(result) {
                /** 
                 * Keep the image data for later
                 */
                imageData = JSON.parse(result);
                refreshLoadedThumbnails();
            }

            function refreshLoadedThumbnails() {
                var htmlStr = "<table width=\"100%\" border=\"1\">";
                var imagePos = 1;
                var image = "";
                var imageTableColWidth = Math.round(100 / userData.imagesPerRow);

                for (var index = 0; index < imageData.files.length; index++) {
                    var path = "/files/user/" + imageData.user + "/loc/" + imageData.loc + "/path/" + imageData.path + "/name/";
                    
                    image = image + "<td width=\"" + imageTableColWidth + "%\"><img onclick=\"displayOriginal(" + index + ", false)\" title=\"" + imageData.files[index].name.name + "\" src=\"" + path +  imageData.files[index].name.encName + "\"></td>";
                    if (imagePos < userData.imagesPerRow) {
                        imagePos++;
                    } else {
                        htmlStr = htmlStr + "<tr>" + image + "</tr>";
                        imagePos = 1;
                        image = "";
                    }
                }
                if (imagePos > 0) {
                    htmlStr += "<tr>" + image + "</tr>";
                }
                htmlStr += "</table>";
                document.getElementById('thumbnailImgeHeading').innerHTML = " [" + imageData.files.length + "] Images for " + imageData.user + " from " + imageData.path;
                document.getElementById('thumbnailImageList').innerHTML = htmlStr;
                displayMap.delete('thumbnailsImage');
                displayPage('thumbnailsImage');
            }

            function displayThumbnailsList() {
                refreshThumbnailList();
                displayPage('thumbnails');
            }

            function displayThumbnailsHistory() {
                var htmlStr = "<table border=\"1\">";
                for (var index = 0; index < userData.imageHistory.length; index++) {
                    htmlStr = htmlStr + "<tr><td><img onclick=\"displayOriginal(" + index + ",true)\" title=\"" + userData.imageHistory[index] + "\" src=\"/image/file/" + userData.imageHistory[index] + "\"></td>";
                    htmlStr = htmlStr + "<td>" + userData.imageHistory[index] + "</td></tr>";
                }
                htmlStr += "</table>";
                document.getElementById('thumbnailImgeHeadingHistory').innerHTML = " [" + userData.imageHistory.length + "] Previously viewed images for " + currentUserCaps;
                document.getElementById('thumbnailImageListHistory').innerHTML = htmlStr;
                displayMap.delete('thumbnailsImageHistory');
                displayPage('thumbnailsImageHistory');
            }

            function loadThumbnails(entryId) {
                linkHistory.push("id" + entryId);
                currentThumbnailPath = imagePathData.paths[entryId].encName;
                document.getElementById('thumbnailImgeHeading').innerHTML = "Please wait. Loading Thumbnails " + currentThumbnailPath;
                serverGetData(displayLoadedThumbnails, responseError, "files/user/" + currentUser + "/loc/images/path/" + currentThumbnailPath);
                displayMap.delete('thumbnailsImage');
                displayPage('thumbnailsImage');
            }


            function setImagesPerRow(n) {
                if ((n > 0) && (n < 10)) {
                    userData.imagesPerRow = n;
                    saveUserData();
                    refreshLoadedThumbnails();
                }
            }

            function displayNextImage(next) {
                if (imageIsHistoric) {
                    return;
                }
                var newIndex = imageIndex + next;
                if ((newIndex >= 0) && (newIndex <= (imageData.length - 1))) {
                    displayOriginal(newIndex, false);
                }
            }

            function displayNextImageXY(event) {
                if (imageIsZoomed) {
                    imageIsZoomed = false;
                    displayOriginal(imageIndex, imageIsHistoric);
                    return;
                }
                var pos_x = event.offsetX ? (event.offsetX) : event.pageX - document.getElementById("pointer_div").offsetLeft;
                var pos_y = event.offsetY ? (event.offsetY) : event.pageY - document.getElementById("pointer_div").offsetTop;

                var width = document.getElementById('originalImageHtmlSrc').offsetWidth;
                var height = document.getElementById('originalImageHtmlSrc').offsetHeight;
                var wUnit = width / 4;
                var hUnit = height / 4;
                if (pos_x < wUnit) {
                    if (imageIsHistoric) {
                        displayPage("thumbnailsImageHistory");
                    } else {
                        displayNextImage(-1);
                    }
                } else {
                    if (pos_x > (wUnit * 3)) {
                        if (imageIsHistoric) {
                            displayPage("thumbnailsImageHistory");
                        } else {
                            displayNextImage(+1);
                        }
                    } else {
                        if ((pos_y < hUnit) || (pos_y > (hUnit * 3))) {
                            if (imageIsHistoric) {
                                displayPage("thumbnailsImageHistory");
                            } else {
                                displayPage("thumbnailsImage");
                            }
                        } else {
                            imageIsZoomed = true;
                            displayOriginal(imageIndex, imageIsHistoric);
                        }
                    }
                }
            }

            function displayOriginal(index, historic) {

                var imageName;
                var fullName;
                var tag;
                if (historic) {
                    imageName = userData.imageHistory[index];
                    fullName = imageName;
                    tag = "H:(" + index + ")";
                } else {
                    imageName = imageData.files[index].name.name;
                    fullName = "/user/" + imageData.user + "/loc/original/path/" + imageData.path + "/name/" + imageName + "?substr=20,4";
                    tag = "C:(" + index + ")";
                }
                imageIndex = index;
                imageIsHistoric = historic;

                if (!historic) {
                    var tempList = [fullName];
                    for (i = 0; i < userData.imageHistory.length; i++) {
                        if (userData.imageHistory[i] !== fullName) {
                            tempList.push(userData.imageHistory[i]);
                        }
                    }
                    userData.imageHistory = tempList.slice(0, historyMaxLen);
                    saveUserData();
                }

                var widthAttr = "width=\"100%\"";
                if (imageIsZoomed) {
                    widthAttr = "";
                }

                var image = "<img " + widthAttr + " id=\"originalImageHtmlSrc\" title=\"" + imageName + "\" src=\"/files" + fullName + "\">";

                if (imageIsZoomed) {
                    document.getElementById('originalImageHtmlZoom').innerHTML = image;
                    displayPage('originalImageZoom');
                    document.getElementById('timeDisplay').hidden = true;

                } else {
                    document.getElementById('originalImageHtml').innerHTML = image;
                    displayPage('originalImage');
                }
            }

            function setLogList(result) {
                var logs = JSON.parse(result);
                var htmlStr = "<table width=\"100%\" border=\"1\">";
                for (var i = 0; i < logs.files.length; i++) {
                    span = "<a href=\"javascript:loadLogFile('" + logs.files[i].name.encName + "')\">" + logs.files[i].name.name + "</a>";
                    htmlStr += "<tr><td style=\"width:20%\">" + logs.files[i].size + "</td><td>" + span + "</td></tr>";
                }
                htmlStr += "</table>";
                document.getElementById('logList').innerHTML = htmlStr;
            }

            function setDiskStatus(result) {
                var ds = JSON.parse(result);
                var htmlStr = "<table width=\"100%\" border=\"1\">";
                for (var i = 0; i < ds.length; i++) {
                    htmlStr += "<tr ><td style=\"width:20%\">" + ds[i].Name + "</td><td>" + ds[i].State + "</td></tr>";
                }
                htmlStr += "</table>";
                document.getElementById('diskStatus').innerHTML = htmlStr;
            }

            function setUserFileSizes(result) {
                document.getElementById('shareSizeText').innerHTML = "Total space used by each user";
                var ufs = JSON.parse(result);
                var htmlStr = "<table width=\"100%\" border=\"1\">";
                for (var i = 0; i < ufs.length; i++) {
                    htmlStr += "<tr><td style=\"width:20%\">" + ufs[i].Name + "</td><td>" + ufs[i].Size + "</td></tr>";
                }
                htmlStr += "</table>";
                document.getElementById('sizeDisplay').innerHTML = htmlStr;
            }


            function setTime(result) {
                var time = JSON.parse(result).time;
                document.getElementById('timeDisplay_date').innerHTML = time.mon + " " + time.dom + " " + time.year;
                document.getElementById('timeDisplay_time').innerHTML = time.hour + ":" + time.min + ":" + time.sec;
            }

            function responseError(message, code) {
                console.log(message + " " + code);
                if (message.charAt(0) === '{') {
                    var err = JSON.parse(message);
                    alert("Status:" + err.Status + " Msg:'" + err.Msg + "' Entity:'" + err.Entity + "'");
                } else {
                    alert("Status:" + code + ". Error Msg:'" + message + "'");
                }
            }

            function response404(message, code) {
                if (code === 404) {
                    return;
                }
                responseError("No Data Found", code);
            }

            function displayUserSelect() {
                displayPage("selectUser");
                document.getElementById('timeDisplay').hidden = true;
            }

            function initTime() {
                serverGetData(setTime, responseError, "server/time?noLog=true");
                if (poleForTime > 0) {
                    window.setTimeout(initTime, poleForTime);
                }
            }

            function validUser() {
                for (var i = 0; i < userList.length; i++) {
                    if (currentUser === userList[i]) {
                        return true;
                    }
                }
                return false;
            }

            function initUserList() {
                var htmlStr = "<table width=\"99%\">";
                for (var i = 0; i < userList.length; i++) {
                    var user = userList[i];
                    var userCaps = capital(user);
                    htmlStr += "<tr>" +
                            "<td width=\"40%\"><img onclick=\"selectUser('" + user + "')\" src=\"/" + user + ".png\" alt=\"" + userCaps + "\" height=\"" + iconSize + "\" width=\"" + iconSize + "\"> </td>" +
                            "<td width=\"40%\" class=\"UserName1\" onclick=\"selectUser('" + user + "')\">" + userCaps + "</td></tr>";
                }
                htmlStr += "</table>";
                document.getElementById('userNameList').innerHTML = htmlStr;
            }

            function capital(name) {
                if (name.length > 0) {
                    return name[0].toUpperCase() + name.substring(1);
                } else {
                    return "";
                }
            }

            function setUserData(result) {
                userData = JSON.parse(result);
                if (userData.imageHistory === undefined) {
                    userData.imageHistory = [];
                }
            }

            function saveUserData() {
                serverPostData(userData, setUserData, responseError, "/files/user/"+currentUser+"/loc/data/path/state/name/state.json");
            }

            function loadUserData() {
                serverGetData(setUserData, responseError, "/files/user/"+currentUser+"/loc/data/path/state/name/state.json");
            }

            window.onload = function () {
                initUserList();
                initTime();
                serverGetData(respAudioStatus, responseError, "audio/status");
                if (validUser()) {
                    selectUser(currentUser);
                } else {
                    displayUserSelect();
                }
            };

            function respAudioStatus(result) {
                var status = JSON.parse(result);
                for (var i = 0; i < volScale.length; i++) {
                    document.getElementById('volB' + i).disabled = false;
                }
                var index = getVolumeScale(status.volume);
                document.getElementById('volB' + index).disabled = true;
                document.getElementById('audioVolume').innerHTML = "[" + volScaleNames[index] + "]";
                if (status.status === "STOPPED") {
                    document.getElementById('audioActive').hidden = true;
                } else {
                    document.getElementById('audioActive').hidden = false;
                    document.getElementById('audioFileName').innerHTML = status.message;
                    document.getElementById('audioState').innerHTML = status.status;
                    document.getElementById('audioDuration').innerHTML = status.duration;
                    document.getElementById('audioPlayed').innerHTML = status.position;
                    window.setTimeout(refreshAudioState, 1000);
                }
            }

            function getVolumeScale(raw) {
                var r = parseInt(raw, 10);
                var i = volScale.length - 1;
                console.log(volScale[i] + "  [" + i + "] [" + r + "]");
                while (volScale[i] > r) {
                    i--;
                    if (i < 0) {
                        return 0;
                    }
                }
                return i;
            }

            function setAudioVolume(level) {
                serverGetData(respAudioStatus, responseError, "audio/volume/" + volScale[level]);
            }

            function setAudioPauseStop(action) {
                serverGetData(respAudioStatus, responseError, "audio/" + action);
            }

            function displayAudioPage() {
                refreshAudioState();
                displayPage("manageAudio");
            }

            function playAudioFile(file) {
                serverGetData(respAudioStatus, responseError, "audio/play/" + file);
            }

            function refreshAudioState() {
                serverGetData(respAudioStatus, responseError, "audio/status");
            }
        </script>
    </head>
    <body >
        <div id="mainFrame" >
            <div class="TopFixed" id="timeDisplay">
                <button class="MenuButton" onclick="displayDetailsPage()">Status</button>
                <button class="MenuButton" onclick="displayThumbnailsList()">Pictures</button>
                <button class="MenuButton" onclick="displayThumbnailsHistory()">History</button>
                <button class="MenuButton" onclick="displayAudioPage()">Audio</button>               
                <span class="SectionName" id="userNameButton"></span>
                <table width="100%" border="1">
                    <tr>
                        <td>Date</td>
                        <td id="timeDisplay_date"></td>
                        <td>Time</td>
                        <td id="timeDisplay_time"></td>
                    </tr>
                </table>
            </div>

            <div class="Top" id="manageAudio">
                <span class="SectionName">Set The Volume: </span>
                <span class="SectionName" id="audioVolume"></span>
                <table width="100%">
                    <tr>
                        <td><button class="MenuButtonSmall" id="volB0" onclick="setAudioVolume(0)">MIN</button></td>
                        <td><button class="MenuButtonSmall" id="volB1" onclick="setAudioVolume(1)">1</button></td>
                        <td><button class="MenuButtonSmall" id="volB2" onclick="setAudioVolume(2)">2</button></td>
                        <td><button class="MenuButtonSmall" id="volB3" onclick="setAudioVolume(3)">3</button></td>
                        <td><button class="MenuButtonSmall" id="volB4" onclick="setAudioVolume(4)">4</button></td>
                        <td><button class="MenuButtonSmall" id="volB5" onclick="setAudioVolume(5)">5</button></td>
                        <td><button class="MenuButtonSmall" id="volB6" onclick="setAudioVolume(6)">6</button></td>
                        <td><button class="MenuButtonSmall" id="volB7" onclick="setAudioVolume(7)">7</button></td>
                        <td><button class="MenuButtonSmall" id="volB8" onclick="setAudioVolume(8)">8</button></td>
                        <td><button class="MenuButtonSmall" id="volB9" onclick="setAudioVolume(9)">MAX</button></td>
                    </tr>
                </table>
                <div id="audioActive">
                    <hr>
                    <span class="SectionName">Playing:&nbsp;</span>
                    <span class="SectionNameGreen" id="audioFileName"></span>
                    <table width="100%" class="SectionName">
                        <tr>
                            <td><span class="SectionNameGreen" id="audioState"></span></td>
                            <td>&nbsp;Duration:&nbsp;</td>
                            <td><span class="SectionNameGreen" id="audioDuration"></span></td>
                            <td>Played:&nbsp;</td>
                            <td><span class="SectionNameGreen" id="audioPlayed"></span></td>
                        </tr>
                    </table>
                    <hr>
                    <table width="100%">
                        <tr>
                            <td colspan="10">
                                <span class="SectionName">Pause:&nbsp;</span>
                                <button class="MenuButtonSmall" onclick="setAudioPauseStop('pause')">(ON/OFF)</button>
                                <span class="SectionName">&nbsp;Playback:&nbsp;</span>
                                <button class="MenuButtonSmall" onclick="setAudioPauseStop('stop')">STOP</button>
                            </td>
                        </tr>
                    </table>
                </div>
                <hr>
                <span class="SectionName">Play&nbsp;</span>              
                <table width="100%">
                    <tr>
                        <td>
                            <button class="MenuButtonWide" onclick="playAudioFile('Chime.mp3')">Chime</button>
                        </td>
                        <td>
                            <button class="MenuButtonWide" onclick="playAudioFile('Bell.mp3')">Bell</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <button class="MenuButtonWide" onclick="playAudioFile('Dog.mp3')">Dog</button>
                        </td>
                        <td>
                            <button class="MenuButtonWide" onclick="playAudioFile('Nature.mp3')">Nature</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <button class="MenuButtonWide" onclick="playAudioFile('Seagulls.mp3')">Seagulls</button>
                        </td>
                        <td>
                            <button class="MenuButtonWide" onclick="playAudioFile('train.ogg')">Train</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <button class="MenuButtonWide" onclick="playAudioFile('BackDoorOpened.mp3')">BackDoorOpened</button>
                        </td>
                    </tr>
                </table>
            </div>

            <div id="originalImage">
                <div onclick="displayNextImageXY(event)" id="originalImageHtml" style="position:absolute; top:80px; left:8px; width:98%; height:100%;"> </div>
            </div>

            <div id="originalImageZoom">
                <div onclick="displayNextImageXY(event)" id="originalImageHtmlZoom" style="position:absolute; top:8px; left:8px"> </div>
            </div>

            <div class="Top" id="thumbnailsImageHistory">
                <span class="SectionName" id="thumbnailImgeHeadingHistory"></span>
                <div id="thumbnailImageListHistory">IMG</div>
                <button class="MenuButtonWide" onclick="displayThumbnailsList()">&#8592; Back to Picture List</button>
            </div>

            <div class="Top" id="thumbnailsImage">
                <span class="SectionName">Number Of Columns:</span>
                <button class="MenuButton" onclick="setImagesPerRow(userData.imagesPerRow - 1)">&#8595; Less</button>
                <button class="MenuButton" onclick="setImagesPerRow(userData.imagesPerRow + 1)">&#8593; More</button><br>
                <span class="SectionName" id="thumbnailImgeHeading"></span>
                <div id="thumbnailImageList">IMG</div>
                <button class="MenuButtonWide" onclick="displayThumbnailsList()">&#8592; Back to Picture List</button>
            </div>

            <div class="Top" id="thumbnails">
                <span class="SectionName" id="thumbnailHeading"></span>
                <div id="thumbnailDirList">DIR</div>
            </div>

            <div class="Top" id="selectUser">
                <span class="UserName2">Who are you?</span>
                <div id="userNameList"></div>
            </div>

            <div class="Top" id="detailsDiv">
                <H4 id="shareSizeText">Share sizes</H4>
                <div id="sizeDisplay"></div>
                <H4>Disk Idle status</H4>
                <div id="diskStatus"></div> 
                <H4>RSync Logs (Latest First)</H4>
                <div id="logList"></div>
            </div> 

            <div class="Top" id="logDisplayDiv">
                <button id="logDisplayFile" onclick="displayPage('detailsDiv')">Back</button>
                <button onclick="reLoadLogFile()">ReLoad</button><br>
                <code id="logDisplayCode">Hello world</code>
            </div>
        </div>
    </body>
</html>
